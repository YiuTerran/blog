---
title: 边缘应用托管方案设计
description:
toc: true
authors: ["tryao"]
tags: ["edge","design"]
categories: []
series: []
date: 2023-02-22T09:12:59+08:00
lastmod: 2023-02-22T09:12:59+08:00
featuredVideo:
featuredImage:
draft: true
---

## 需求与现状

我们需要一套方案，来解决边侧应用部署的问题。这不仅仅包括边缘网关，同时还应包括独立部署整个iot平台，以及任意第三方服务。当然，除了部署之外，还有**权限隔离**、**运行监测**（可观测性）和**远程调试**等常见的需求。目前来说，我们**不需要**考虑边缘端服务器配置轻量化需求，所以后面略去了这部分的考量。

目前，IoT云测服务运行于阿里云托管的k8s中，相关权限在运维手中。跟院里大部分服务一样，IoT整体架构并不强依赖于k8s，而是使用了SpringCloud等框架，换句话来说，并没有云原生化。特别地，视频云服务使用了大量UDP based（RTP/SIP）协议，而k8s对于非TCP based协议的网络支持都比较有限，短时间内恐怕很难on k8s. 所以，**我们必须同时支持k8s部署和普通部署**。

我们可以强制要求所有的应用运行在**容器**中，通过合理规划端口使用和卷挂载，理论上可以解决绝大部分服务运行问题。但是第三方应用（如视频AI之类的）可能不支持容器化，当然这种情况也可以让他们自己部署。那么，我们的方案最好的情况需要支持三级部署：裸程序、容器化和k8s里，次一级也至少支持容器化和k8s两种。

边侧服务除掉最早期使用windows server的版本，目前都运行在一期基于k3s的应用托管容器中。目前的应用托管（以下简称v1）架构比较简单：

![06508ac1f18f5a725dde24846f37f753-20230218195750](https://csceciti-iot-devfile.oss-cn-shenzhen.aliyuncs.com/docs/06508ac1f18f5a725dde24846f37f753-20230218195750.png)

云端是一个rancher集群，边侧就是一个k3s集群（类似于一个k8s集群），云边之间有建立websocket通道，而各边侧之间是相互隔离的（当然可以通过云端rancher中转通信，不过这个不是out-of-box的）。该方案对云端有没有k8s没有需求。

墨斗通过调用rancher的各种API，来与pod中的服务进行交互，从而可以达到远程调试的目的。

通过额外在k3s中部署MetricServer，Prometheus等服务，也可以将数据采集并上报到云端。当然这个问题需要细化讨论，第三方托管服务的可观测性可能需要他们自己想办法解决，或者我们提供一套SDK供他们收集日志之类的。

此外，rancher也提供了较为完善的API做权限隔离。所以虽然目前还做的比较简陋，但是显然该方案可以解决**所有服务都能跑在k8s中的需求**。

## 统一托管方案

### 裸机部署

裸程序部署方案，在k8s甚至docker出现之前就有很多，但是大都已经是明日黄花。目前社区中尚有人气的主要是[hashicorp](https://github.com/hashicorp)/**[nomad](https://github.com/hashicorp/nomad)**，该方案使用了与k8s编排容器完全不同的抽象方式，从而能够部署非容器化应用，该方案的问题也是它**并不支持**k8s生态。换句话说，一台裸Linux上可以同时存在docker和k8s和普通二进制服务，但是不能同时存在nomad和k8s，所以除非全面倒向nomad生态，不然一般是不考虑使用的。

我们把要求放低一点，如果是裸机的普通控制，实际上**并不需要考虑部署**的事情，只要给用户一个远程交互的界面，其他的让他自己处理就行。就像向日葵这种远程桌面一样，理论上远程机器上有一个websocket的agent就可以通过web进行远程管理了。这样的工具还是有一些的，如[rport](https://github.com/cloudradar-monitoring/rport)，该开源项目同时支持linux/windows/mac，并支持X86/ARM等多种架构（这是因为agent是用go写的）。功能上支持**远程桌面**，也支持**webshell**，整体有点像阿里云ECS的控制台。

另外值得一提的是，该项目的部署方案十分完善，提供了大量自动化脚本应对各种情况。

![dashboard-with-client-inventory](https://csceciti-iot-devfile.oss-cn-shenzhen.aliyuncs.com/docs/dashboard-with-client-inventory.jpg)

上面是一张截图，不过我们实际上应该只会通过API与之交互。

裸机部署很难统一应用交付方式，服务一般是通过各种脚本来启动。一般也不考虑环境隔离的问题，可以通过windows/linux创建非管理员账户来限制租户的权限，总之都是比较传统的方案。

特别需要注意的是，裸机方案不仅适配于应用托管，在更小型的环境里（如树莓派或者更低的配置）运行应用程序都应当考虑该方案。因为docker启动之后至少需要200~300M内存，k3s更是需求1G内存。

此外，虽然很少，但是对于某些强依赖windows环境的应用，也只能采用裸机部署方案。

### 容器部署

其实rancher1.x的时候就支持docker swarm的裸机部署，不过rancher从2.0开始就只支持k8s了。

目前流行的开源方案中，[portainer](https://www.portainer.io/)是功能比较全面的容器环境管理系统，它不仅支持docker compose/k8s，甚至还支持前面提到的namod方案。

![portainer-architecture-detailed](https://csceciti-iot-devfile.oss-cn-shenzhen.aliyuncs.com/docs/portainer-architecture-detailed.png)

这个是它的架构图。左侧是边缘Agent，右侧是云端Agent. 该服务最开始的架构是pull模型，EdgeAgent在内网，只能改成push模型。

与想象的不同，该方案的Agent与Server是按需连接的。EdgeAgent会每隔几秒（默认是5秒）探测一下服务端是否需要建立长连接，需要的话才会建立websocket通道。所以Edge与Server的通信建立可能有一定的延迟。

![image-20230223173543309](https://csceciti-iot-devfile.oss-cn-shenzhen.aliyuncs.com/docs/image-20230223173543309.png)

上面是该服务运行时截图。

经过测试，portainer可以比较完美的支持容器部署的常用功能，并能直接透传docker命令。k8s的支持稍弱，不过也能使用helm部署，和自定义API对象模板，足够满足一般使用需求。

对于应用部署，docker环境提供了简单的表单方案，当然支持直接上传compose file；k8s环境也支持通过表单简单部署ReplicaSets. 当然k8s环境可以使用其他部署方案，不一定要走他这一套，后面会详述。

有一定的权限隔离支持，但是不太完善（RBAC属于收费功能），可以通过前端封装API来解决相关问题。

总体来说，`portainer`配合docker和k3s集群，可以解决大部分应用部署的问题。需要注意的是，portainer的官方地址疑似被墙，安装脚本虽然完善，但是需要改动才能使用（当然k8s本身就被墙了……）。

### k8s部署

这个可选的方案就很多了，目前在用的k3s+rancher也是比较成熟的方案，当然也可以用上面说的portainer+k3s替代。除此之外还有KubeEdge/OpenYurt等边缘计算的方案，下面对这些方案做一个简单对比。

#### k3s+rancher/portainer

前文已经说过这种架构，v1版本用rancher2.x配合k3s可以解决大部分k8s内部署的问题，k3s对k8s做了精简，并且自带了LocalPV和Ingress的配置，开箱即用。不过rancher没有官方的API指南，需要自行抓包看API，这点不如portainer; rancher的优势是用户更多，知名度更大，这样理论上会更加稳定一些。

这种架构最大的特点，是服务端并不需要k8s集群。这有利有弊，好处当然是比较轻量封闭；坏处是无法进行云边算力协同，边与边之间的集群也没有任何关系。如果是完全云原生化的服务，分区域部署，显然不能使用该方案。对于

### 小结

## 交互简化方案

云原生应用存在所谓的OAM模型

## 边缘计算/边云融合方案

## IoT服务完全云原生化方案

## 应用托管（边缘容器）整体架构

