---
title: 时序数据规则引擎设计思路
description:
toc: true
authors: []
tags: []
categories: []
series: []
date: 2024-03-08T09:02:16+08:00
lastmod: 2024-03-08T09:02:16+08:00
featuredVideo:
featuredImage:
draft: false
---

在物联网数据、日志收集等场景中，基于时序数据来做一些规则的需求一直存在，最简单的比如告警、通知等。实现思路也有很多，大致记载一下。

## 基于周期性计算

比如kibana、zabbix等，使用SQL或其他DSL创建告警条件，服务器会周期性地运行这些条件，判断满足则触发动作。

![image-20221021090656229](https://csceciti-iot-devfile.oss-cn-shenzhen.aliyuncs.com/docs/EqnO2xCD1f6Hb8R.png)

上图是kibana的一个基于日志等级预警的例子，可以看出来其实大概就是`select count(*) from logs-golang* where log.level='ERROR' and ts > now()-1m`的结果与1进行比较的意思。

每分钟运行上述规则一次，即可以判断是否发生预警。

数据先入库，然后再定时计算，这样做的好处是架构比较简单，基于SQL或类SQL的DSL来写表达式即可，同时可以提供类似上面的图形界面，用于简化配置，对于使用者的要求不高。坏处是不够即时，kibana这里要求间隔至少是1分钟1次，所以告警可能会延迟1分钟。此外，频繁的周期性调度，对性能影响也比较大。

此外，这种方式计算的数据并不会入库。当然如果是时序数据，可以基于ts定时计算后再入库，因为时序数据是不变的。如果是一般的数据，需要计算入库就必须用流式计算来进行了。

## 基于物化视图

部分时序数据库（如TDEngine、Clickhouse）支持类似物化视图的技术，可以在输入写入库时，直接基于物化视图计算出需要的值。不过这个只能用于规则引擎输出统计值时，如果想要告警，还是需要订阅物化视图的数据变更，然后回调。

## 基于实时流计算

即类似FlinkCDC的思路来做。thingsboard的规则引擎是基于消息到来时进行触发，但是只能处理单条消息，没有使用时间窗口技术，所以是个半成品。真正的流计算必须使用类似Flink的时间窗口技术，并允许跨多条消息进行处理。

这种情况下，平台应提供允许客户自行上传jar包，或者脚本的方式来写处理逻辑。每当有数据到来时，如果满足用户自己设置的规则条件，则回调用户自己写的处理逻辑即可。该方案对使用者的要求较高，必须是开发者才能正确处理。

## 建议实施步骤

基于单条数据的实时处理最为简单，可以优先实现，满足5成以上的需求；

基于周期性计算的规则引擎更容易图形化，实现起来也相对简单（但是要采用一种DSL），非即时计算的场景可以采用该方案；

基于CDC的方案最为灵活，但是对使用者的要求较高，实现起来也有一些技术难度，在对实时性要求极强的场景下可以采用该方案；
